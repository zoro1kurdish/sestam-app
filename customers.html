<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بەڕێوەبردنی کڕیارەکان</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2><i class="fas fa-calculator me-2"></i>ژمێریاری MUHAMMAD</h2>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link"><i class="fas fa-home"></i> داشبۆرد</a>
            <a href="customers.html" class="nav-link active"><i class="fas fa-users"></i> کڕیارەکان</a>
            <a href="sales.html" class="nav-link"><i class="fas fa-chart-line"></i> فرۆشتن</a>
            <a href="purchases.html" class="nav-link"><i class="fas fa-shopping-cart"></i> کڕین</a>
            <a href="inventory.html" class="nav-link"><i class="fas fa-boxes"></i> کۆگا</a>
            <a href="add-items.html" class="nav-link"><i class="fas fa-plus-circle"></i> زیادکردنی کاڵا</a>
            <a href="reports.html" class="nav-link"><i class="fas fa-file-alt"></i> ڕاپۆرت</a>
            <a href="daily-book.html" class="nav-link"><i class="fas fa-book"></i> دەفتەری ڕۆژانە</a>
            <a href="admin.html" class="nav-link"><i class="fas fa-user-shield"></i> ئادمین</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header mb-4">
            <button class="btn d-lg-none" type="button" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h4 class="mb-0">بەڕێوەبردنی کڕیارەکان</h4>
            <div class="ms-auto">
                <button class="btn btn-primary" id="add-customer-btn">
                    <i class="fas fa-plus me-2"></i>زیادکردنی کڕیاری نوێ
                </button>
            </div>
        </header>

        <!-- Customers Table -->
        <div class="card card-custom">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-custom">
                        <thead>
                            <tr>
                                <th>ناو</th>
                                <th>ژمارە تەلەفۆن</th>
                                <th>ناونیشان</th>
                                <th>ئیمەیڵ</th>
                                <th>کردارەکان</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body">
                            <!-- Rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal fade" id="customer-modal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customer-modal-title">زیادکردنی کڕیار</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customer-form">
                        <input type="hidden" id="customer-id">
                        <div class="mb-3">
                            <label for="customer-name" class="form-label">ناوی کڕیار</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="customer-phone" class="form-label">ژمارە تەلەفۆن</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                        <div class="mb-3">
                            <label for="customer-address" class="form-label">ناونیشان</label>
                            <input type="text" class="form-control" id="customer-address">
                        </div>
                        <div class="mb-3">
                            <label for="customer-email" class="form-label">ئیمەیڵ</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">داخستن</button>
                            <button type="submit" class="btn btn-primary" id="save-customer-btn">پاشەکەوتکردن</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const customerModalEl = document.getElementById('customer-modal');
            const customerModal = new bootstrap.Modal(customerModalEl);
            const customerForm = document.getElementById('customer-form');
            const customerModalTitle = document.getElementById('customer-modal-title');
            const customerIdInput = document.getElementById('customer-id');
            const customersTableBody = document.getElementById('customers-table-body');

            // Function to fetch and display customers
            const fetchCustomers = async () => {
                try {
                    const response = await fetch('/api/customers');
                    const customers = await response.json();
                    
                    customersTableBody.innerHTML = ''; // Clear existing rows
                    if (customers.length === 0) {
                        customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center">هیچ کڕیارێک نەدۆزرایەوە.</td></tr>';
                        return;
                    }

                    customers.forEach(customer => {
                        const row = `
                            <tr>
                                <td>${customer.name}</td>
                                <td>${customer.phone || '-'}</td>
                                <td>${customer.address || '-'}</td>
                                <td>${customer.email || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${customer.id}"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${customer.id}"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `;
                        customersTableBody.insertAdjacentHTML('beforeend', row);
                    });
                } catch (error) {
                    console.error('Error fetching customers:', error);
                    customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">هەڵەیەک ڕوویدا لە کاتی هێنانی زانیاری.</td></tr>';
                }
            };

            // Handle "Add Customer" button click
            document.getElementById('add-customer-btn').addEventListener('click', () => {
                customerForm.reset();
                customerIdInput.value = '';
                customerModalTitle.textContent = 'زیادکردنی کڕیاری نوێ';
                customerModal.show();
            });

            // Handle form submission for both add and edit
            customerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = customerIdInput.value;
                const customerData = {
                    name: document.getElementById('customer-name').value,
                    phone: document.getElementById('customer-phone').value,
                    address: document.getElementById('customer-address').value,
                    email: document.getElementById('customer-email').value,
                };

                const url = id ? `/api/customers/${id}` : '/api/customers';
                const method = id ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-role': 'admin' // Assuming admin action
                        },
                        body: JSON.stringify(customerData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save customer');
                    }

                    customerModal.hide();
                    fetchCustomers(); // Refresh the table
                } catch (error) {
                    console.error('Error saving customer:', error);
                    alert('هەڵەیەک ڕوویدا: ' + error.message);
                }
            });

            // Handle Edit and Delete buttons using event delegation
            customersTableBody.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const id = editBtn.dataset.id;
                    try {
                        const response = await fetch(`/api/customers/${id}`);
                        if (!response.ok) throw new Error('Customer not found');
                        const customer = await response.json();
                        
                        // Populate and show the modal
                        customerModalTitle.textContent = 'دەستکاریکردنی کڕیار';
                        customerIdInput.value = customer.id;
                        document.getElementById('customer-name').value = customer.name;
                        document.getElementById('customer-phone').value = customer.phone || '';
                        document.getElementById('customer-address').value = customer.address || '';
                        document.getElementById('customer-email').value = customer.email || '';
                        customerModal.show();
                    } catch (error) {
                        console.error('Error fetching customer for edit:', error);
                    }
                }

                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('دڵنیایت لە سڕینەوەی ئەم کڕیارە؟')) {
                        try {
                            const response = await fetch(`/api/customers/${id}`, {
                                method: 'DELETE',
                                headers: { 'x-user-role': 'admin' }
                            });

                            if (!response.ok) {
                                throw new Error('Failed to delete customer');
                            }
                            fetchCustomers(); // Refresh the table
                        } catch (error) {
                            console.error('Error deleting customer:', error);
                            alert('هەڵەیەک ڕوویدا لە کاتی سڕینەوە.');
                        }
                    }
                }
            });

            // Initial fetch of customers
            fetchCustomers();
        });
    </script>
</body>
</html>
